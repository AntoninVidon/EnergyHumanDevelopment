# Results

```{r, echo=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(patchwork)
library(Lock5withR)
library(ggpubr)
library(stringr)
library(esquisse)
library(gganimate)
library(ggrepel)
library(GGally)
library(parcoords)
library(tools)
library(grid)
library(leaflet)
library(rgdal)
```


```{r echo=FALSE, warning=FALSE}
# Load Data
master_df <- read.csv(file = "data/master.csv")
```

## Association of Human Development and Renewable Energy 
```{r}
data_country_info <- read.csv("data/worldbank_country_info.csv", header=TRUE, stringsAsFactors=FALSE, encoding = "UTF-8")
df_country_info <- as.data.frame(data_country_info)
df_country_info <- as.data.frame(data_country_info) %>% 
  rename(c(ISO_code = "X.U.FEFF.iso_code", region="Region", income_group="IncomeGroup"))
df_country_info <- df_country_info %>% select(c("ISO_code", "region", "income_group"))

master_df <- left_join(master_df, df_country_info, by = "ISO_code")
```

The earlier analysis of GDP and energy consumption shows that economic growth, energy consumption, and human development are correlated until a threshold on the economic growth is reached. Considering the growing importance of renewable energy and the negative effects fossil energy sources can have on human livelihood, we must understand the **relation of renewable energy and human development**.

```{r, fig.width=8, fig.height=4}
par(mfrow=c(1,2))

graph_df <- master_df[master_df$year==2019 & master_df$country != "Iceland"  & master_df$country != "Norway",]
p1 <- ggplot(graph_df, aes(x=renew/population*1000000000, y=HDI)) +
  geom_point(aes(color = region)) +
  geom_smooth(method="lm") +
  theme_classic() + 
  theme(legend.position="none") +
  geom_text(
    label=graph_df$country, 
    nudge_x = 0, nudge_y = 0.02,
    size = 3,
    check_overlap = T
  ) +
  scale_x_log10() +
  labs(x="Renewable energy consumption per capita (in MWh)", y="HDI", color="Region", caption = "")


p2 <- ggplot(graph_df, aes(x=renew/primary*100, y=HDI)) +
  geom_point(aes(color = region)) +
  geom_smooth(method="lm") +
  theme_classic() + 
  theme(legend.position="none") +
  geom_text(
    label=graph_df$country, 
    nudge_x = 0, nudge_y = 0.02,
    size = 3,
    check_overlap = T
  ) +
  labs(x="Share of renewables to overall energy consumption (in %)", y="", color="Region", caption = "Extreme outliers were removed. Data from 2019")

get_only_legend <- function(plot) { 
  plot_table <- ggplot_gtable(ggplot_build(plot))  
  legend_plot <- which(sapply(plot_table$grobs, function(x) x$name) == "guide-box")
  legend <- plot_table$grobs[[legend_plot]] 
  return(legend)  
}

p1_legend <- ggplot(graph_df, aes(x=renew/primary*100, y=HDI)) +
  geom_point(aes(color = region)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(color="Region")

legend <- get_only_legend(p1_legend)
combined_plot <- gridExtra::grid.arrange(p1, p2, ncol=2)
gridExtra::grid.arrange(combined_plot, legend, nrow=2, heights = c(9, 2), top = textGrob("Relation of HDI Score to Renewable Energy Consumption"))
```

There is both a **positive correlation between HDI and renewable energy consumption** both in per capita and in relative terms. However, we can also see that countries with a low share of renewable energy consumption like Hong Kong or Australia achieve high levels of human development. Moreover, does the plot on the left support the fact that higher overall energy consumption correlates with human development. Nevertheless, we can deduct that more developed countries also invest more in renewable energy.
```{r}
energy_vars <- c("fossil_fuel", "hydro", "low_carb", "nuclear", "other_renew", "renew", "solar", "wind", "coal", "gas", "oil", "biofuel", "primary")
distinct_energy_vars <- c("hydro", "nuclear", "solar", "wind", "coal", "gas", "oil", "biofuel", "other_renew")


scat_mat_lr <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point() + 
    geom_smooth(method=lm, fill="blue", color="blue", ...)
  p
}
```

```{r, fig.height=4}
perct_df <- master_df
perct_df[energy_vars] <- (perct_df[energy_vars] / rowSums(perct_df[distinct_energy_vars])) * 100
perct_df_2019 <- perct_df[perct_df$year==2019,]

graph_df <- perct_df_2019 %>% rename("Life expectancy"="life_expectancy", "Years of schooling"="years_of_schooling", "Renewables share"="renew")

ggpairs(graph_df, columns = c(6, 7, 8, 14), lower = list(continuous = scat_mat_lr)) +
  labs(title = "Human development metrics and renewable energy") + labs(caption = "Data from 2019") + 
  theme_classic() +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))
```

Statistically significantly more countries with a high share of renewable energy are also those countries in which citizens have a higher life expectancy and tend to receive more education. While life expectancy is left-skewed and years of schooling is normally distributed, the share of renewables is strongly right-skewed. This indicates great room for improvement in investments into renewable energy.

* * *

## Characteristics of Countries With a High Share of Renewable Energy 
(There is no data on renewable energy available for 91 countries. These countries are mainly in Africa.)

```{r, echo=FALSE}
# What countries have a high share of renewables today?

getwd()
#Read shape file
world_spdf <- readOGR( 
  dsn= paste0(getwd(), "/R/world_shape_file"), 
  layer="TM_WORLD_BORDERS_SIMPL-0.3",
  verbose=FALSE
)
#Clean data object
world_spdf@data$POP2005[ which(world_spdf@data$POP2005 == 0)] = NA
world_spdf@data$POP2005 <- as.numeric(as.character(world_spdf@data$POP2005)) / 1000000 %>% round(2)

# Create a color palette for the map:
mypalette <- colorNumeric( palette="viridis", domain = world_spdf@data$POP2005, na.color="transparent")
mypalette(c(45,43))

# Display map
m <- leaflet(world_spdf) %>% 
  addTiles()  %>% 
  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( fillColor = ~mypalette(POP2005), stroke=FALSE )

m
```
TODO: Make as map

```{r, echo=FALSE}
# How does the share of renewable energy change in different countries?
graph_df <- master_df %>% 
  filter(!is.na(renew))
graph_df$income_group[graph_df$country=="Venezuela"] <- "Lower middle income"
graph_df <- graph_df %>%
  group_by(income_group, year) %>% 
  summarise(renew = sum(renew), primary = sum(primary))

graph_df$label <- NA
graph_df$label[which(graph_df$year == max(graph_df$year))] <- graph_df$income_group[which(graph_df$year == max(graph_df$year))]
ggplot(graph_df, aes(x=year, y=renew/primary*100, group=income_group, color=income_group)) +
  geom_line() +
  theme_light() + 
  theme(legend.position="none") +
  labs(x="Year", y="Share of renewable energy (in %)") +
  geom_label_repel(aes(label = label), nudge_x = 1, na.rm = TRUE)
```
(Low income data is missing)
How many countries per income?
What income ranges are associated with the income levels?


```{r, echo=FALSE}
# What is the energy mix of the most renewable and the least renewable countries?
graph_df <- master_df %>% filter(year==2019)
graph_df <- graph_df %>% arrange(desc(renew/primary)) %>% slice(1:10) %>% select(-c("primary", "fossil_fuel", "renew"))
graph_df <- graph_df %>% pivot_longer(distinct_energy_vars, names_to = "energy")
graph_df$value_per_capita <- graph_df$value / graph_df$population
graph_df$energy <- sub("other_renew", "Other Renewables", graph_df$energy)
graph_df$energy <- toTitleCase(graph_df$energy)
levels <- names(sort(tapply(graph_df$value_per_capita, graph_df$energy, sum)))

ggplot(graph_df, aes(x=reorder(country, -value_per_capita*1000000), y=value_per_capita*1000000, fill=factor(energy, levels=levels))) +
  geom_bar(stat="identity") +
  theme_light() + 
  theme(axis.text = element_text(angle = 45, vjust = 0, hjust = 1)) +
  scale_fill_manual(values=c("#eabc35", "#8d9e2b", "#7cabcb", "#645f55", "#c0b879", "#d0d890", "#b18781", "black", "#1e7991")) +
  labs(y="Energy mix per capita (in MWh)", x="Country", fill="Energy source")
```
TODO: Title
<u>Observations:</u>

- The countries highest share of renewable energy in their energy 
- Stronger correlation between absolute renewable energy consumption because there is also a strong positive correlation between human development and energy consumption independent of the energy source
- Norway and Iceland are far outliers in the renewable energy consumption with 65 to nearly 80% renewables in their energy mix
- Citizens of many countries consume a similar amount of renewable energy but experience varying levels of human development

```{r}
# Calculate average energy mix of top 10 most renewable countries and compare to the rest of the world
perct_graph_df <- master_df
perct_graph_df[energy_vars] <- (perct_graph_df[energy_vars] / rowSums(perct_df[distinct_energy_vars])) *100
perc_df_2019 <- perct_graph_df %>% filter(year==2019)
top_ten_df <- perc_df_2019 %>% arrange(desc(renew/primary)) %>% slice(1:10) %>% select(-c("primary", "fossil_fuel", "renew"))
top_ten_df <- top_ten_df %>% pivot_longer(distinct_energy_vars, names_to = "energy")
top_ten_df <- top_ten_df %>% group_by(energy) %>%
  summarise(value = mean(value))
top_ten_df$name <- "Top Ten"

average_df <- perc_df_2019 %>% arrange(desc(renew/primary)) %>% slice(11:nrow(.)) %>% select(-c("primary", "fossil_fuel", "renew"))
average_df <- average_df %>% pivot_longer(distinct_energy_vars, names_to = "energy") %>% drop_na(value)
average_df <- average_df %>% group_by(energy) %>%
  summarise(value = mean(value))
average_df$name <- "Rest average"


compare_df <- rbind(top_ten_df, average_df)
compare_df$energy <- sub("other_renew", "Other Renewables", compare_df$energy)
compare_df$energy <- toTitleCase(compare_df$energy)

ggplot(compare_df, aes(x=name, y=value, fill=factor(energy, levels=levels))) +
  geom_bar(stat="identity") +
  theme_light() + 
  scale_fill_manual(values=c("#eabc35", "#8d9e2b", "#7cabcb", "#645f55", "#c0b879","#d0d890", "#b18781", "black", "#1e7991")) +
  labs(y="Energy mix (in %)", x="Class", fill="Energy source")
```

```{r}
#interactive_plot <- master_df[master_df$year==2019,] %>% 
#  select (-c("ISO_code","year", "population", "hydro", "nuclear", "solar", "wind", "coal", "gas", "oil", "biofuel"))  %>%
#  parcoords(rownames = FALSE, brushMode = "1d-axes", reorderable = TRUE, queue = T,color = list(colorBy = "region"), withD3=TRUE)

#interactive_plot
```




### Ideas:
- outlier analysis
- filter on GDP or population to make trends appear
- cluster countries by energy mix
- development of different income areas



On the other hand, how does the production of coal and gas energy leading to more pollution might foster and hinder human development at the same time?
- countries might consume other energy than they produce
- 


