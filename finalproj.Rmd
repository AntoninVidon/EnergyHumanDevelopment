--- 
title: "Energy and Human Development"
author: "Antonin Vidon and Jannik Wiedenhaupt"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

The effect of energy consumption on economic growth is an important and long-existing area of research and teaches us that energy is one of the most important drivers of economic development. However, it is not only the economic development that relates to energy consumption but also broader human development. Considering the growing importance of different energy sources and the looming transition from fossil fuels to renewable energy sources, it is important to understand how energy consumption and human livelihood are related. In our study, we therefore examine human development and its core components, as collected in the human development indicator (HDI): A long and healthy life, the duration of education and the standard of living. This allows us to highlight potential misconceptions about the relationships between the development stages of countries and suggestions for policy-making.

**With this analysis we answer the following five questions**:

1. How is the increase in energy consumption boosting the education system in order to cope with the industrial ”boom” generated by rapid economic growth?
2. What are the most important factors that determine how a variation of energy consumption affects the human development index of a country?  
3. Is the rate at which the HDI increases with respect to energy consumption constant, or does it start to decrease after a specific GDP per capita?
4. Is a highly renewable energy mix associated with strong human development indicators?
5. What characterizes the countries that have the most renewable energy mix?  

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources


This is an overview of all data sources for this project. The multivariate analysis conducted in the rest of the book is solely based on these data sets.

### Population {.unlisted .unnumbered}

<u>Data description:</u> *Total population is based on the de facto definition of population, which counts all residents regardless of legal status or citizenship.*

[Link to data.](https://data.worldbank.org/indicator/SP.POP.TOTL)


### GDP {.unlisted .unnumbered}

<u>Data description:</u> *Measure of a country's economic output computed by adding up the monetary value (in current US$) of all finished goods and services made within a country for a given year.*

[Link to data.](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD)


### HDI {.unlisted .unnumbered}

<u>Data description:</u> *Composite index measuring average achievement in three basic dimensions of human development-a long and healthy life, knowledge and a decent standard of living.*

[Link to data.](http://hdr.undp.org/en/indicators/137506)


### Life expectancy {.unlisted .unnumbered}

<u>Data description:</u> *Mean length of life of an actual birth cohort (all individuals born in a given year).*

[Link to data.](https://data.worldbank.org/indicator/SP.DYN.LE00.IN) 


### Years of schooling {.unlisted .unnumbered}

<u>Data description:</u> *Number of years of schooling that a child of school entrance age can expect to receive if prevailing patterns of age-specific enrollment rates persist throughout the child's life.*

[Link to data.](http://hdr.undp.org/en/indicators/69706#)


### Energy consumption {.unlisted .unnumbered}

<u>Data description:</u> *Energy consumption by source, country and year.*

[Link to data.](https://github.com/owid/energy-data)


### Country info {.unlisted .unnumbered}

<u>Data description:</u> *ISO code, region and level of income for all worldbank-recognized regions The .csv dataframe is in the same zip as the one containing GDP data (first source).*

[Link to data.](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD)









<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation

```{r, echo=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(countrycode)
```

We aim at merging all data into one tidy master data frame within which **each observation will correspond to one country and one year**.

## Selecting the time range

We hope to keep a sufficiently wide range so as to **observe clear change in energy consumption behavior across time**. 


```{r}
# Load all data sets
df_population_wide <- read.csv("data/population.csv", skip = 4, check.names = FALSE)
df_GDP_wide <- read.csv("data/worldbank_GDP.csv", skip = 4, check.names = FALSE)
df_HDI_wide <- read.csv("data/HDI.csv", skip = 5, check.names = FALSE)
df_life_wide <- read.csv("data/life_expectancy.csv", skip = 4, check.names = FALSE)
df_schooling_wide <- read.csv("data/un_years_of_schooling.csv", skip = 6, check.names = FALSE)
df_energy_long <- read.csv("data/owid_energy_data.csv", header = TRUE, stringsAsFactors = FALSE)
df_country_info <- read.csv("data/worldbank_country_info.csv", header = TRUE, stringsAsFactors = FALSE, encoding = "UTF-8")
```

```{r}
year_availability <- matrix(NaN, 6, 2)
colnames(year_availability) <- c("Min year", "Max year")
rownames(year_availability) <- c("Energy consumption" , "Years of schooling" , "Life expectancy" , "HDI" , "GDP", "Population")

year_availability[6,] <- c(1960, 2020)
year_availability[5,] <- c(1960, 2020)
year_availability[4,] <- c(1990, 2019)
year_availability[3,] <- c(1960, 2020)
year_availability[2,] <- c(1990, 2019)
year_availability[1,] <- c(1900, 2020)

## ncol and nrow
nr <- nrow(year_availability)
nc <- ncol(year_availability)

## separation between bars
sepr <- 0.2

op <- par(mar = c(5,9,4,2) + 0.1)

plot(c(1900,2020), c(1,nr), type="n",
     ylim=c(1-(1-sepr)/2-sepr,
            nr+(1-sepr)/2+sepr),
     ylab="", yaxt="n",
     xlab="", main = "Time range for each data set")
grid(ny = NA)

## plot bars
for(i in 1:nr) {
    lo <- year_availability[i,1]
    hi <- year_availability[i,2]
    polygon(x=c(lo, lo, hi, hi),
            y=c(i-(1-sepr)/2, i+(1-sepr)/2,
                i+(1-sepr)/2, i-(1-sepr)/2), col = "#6495ED")
}

## create y-axis
axis(2, at=1:nr, las=2, xpd=NA, labels=rownames(year_availability)) 
legend("topleft", fill="#6495ED", bty="n", legend="year is recorded")
## add center line
abline(v=0, lty=2)
```

We choose to restrict our multivariate analysis to the narrowest time range. This is exactly the intersection of all ranges : **1990-2019**.

We note that this plot **does not tell us anything about missing values**. Indeed, a given observation might be missing although within the time range of the data set.

* * *

## Selecting the variables

We hope to be able to analyze and understand the cross-correlation between energy consumption and human development. To do so, we figured we would need the following:

- data indicators for **HDI and all its major components**, namely: `GDP`, `life_expectancy`, `years_of_schooling`;
- figures for **consumption per energy type**;
- population.


```{r}
# except from year and country
variable <- c("ISO_code", "HDI", "population", 
             "years_of_schooling", "life_expectancy", "GDP", "fossil_fuel", "hydro", "low_carb", 
               "nuclear", "other_renew", "renew", "solar", "wind", 
               "coal", "gas", "oil", "biofuel", "primary")
dataset <- c("worldbank_country_info", "HDI", "population", "un_years_of_schooling", "life_expectancy",
             "worldbank_gdp", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data", "owid_energy_data")

chosen_variables <- data.frame(variable, dataset)

knitr::kable(chosen_variables, "html")
```

```{r, warning=FALSE}
# Choose years
relevant_years <- as.character(1990:2019)

df_energy_long <- df_energy_long %>% 
  select(-contains(c("_per_capita", "_pct", "_change", "_production", "_share"))) %>%
  subset(year %in% relevant_years) %>%
  rename("ISO_code" = "iso_code") %>%
  subset(ISO_code != "") %>%
  rename("fossil_fuel" = "fossil_fuel_consumption", 
         "hydro" = "hydro_consumption", 
         "low_carb" = "low_carbon_consumption", 
         "nuclear" = "nuclear_consumption", 
         "other_renew" = "other_renewable_consumption", 
         "renew" = "renewables_consumption", 
         "solar" = "solar_consumption", 
         "wind" = "wind_consumption", 
         "coal" = "coal_consumption", 
         "gas" = "gas_consumption", 
         "oil" = "oil_consumption", 
         "biofuel" = "biofuel_consumption", 
         "primary" = "primary_energy_consumption") %>%
  select("ISO_code", "year", "fossil_fuel", "hydro", "low_carb", "nuclear", "other_renew", "renew", 
         "solar", "wind", "coal", "gas", "oil", "biofuel", "primary")

df_energy_ISO_with_no_missing_year <- df_energy_long %>%
  select("ISO_code", "year") %>%
  group_by(ISO_code) %>%
  summarize(count = n()) %>%
  filter(count == 2019 - 1990 + 1) %>%
  pull(ISO_code)

df_energy_long <- df_energy_long %>%
  filter(ISO_code %in% df_energy_ISO_with_no_missing_year)



df_GDP_wide <- df_GDP_wide %>%
  select("Country Name", "Country Code", relevant_years) %>%
  rename("country" = "Country Name", "ISO_code" = "Country Code") %>%
  mutate_at(relevant_years, as.numeric) %>%
  select("ISO_code", relevant_years)
  


df_life_wide <- df_life_wide %>%
  select("Country Name", "Country Code", relevant_years) %>%
  rename("country" = "Country Name", "ISO_code" = "Country Code") %>%
  mutate_at(relevant_years, as.numeric) %>%
  select("ISO_code", relevant_years)


df_schooling_wide <- df_schooling_wide %>%
  select("Country", relevant_years) %>%
  mutate("ISO_code" = countrycode(Country, origin = "country.name", destination = "iso3c")) %>%
  mutate_at(relevant_years, as.numeric) %>%
  select("ISO_code", relevant_years)


df_population_wide <- df_population_wide %>%
  select("Country Name", "Country Code", relevant_years) %>%
  rename("country" = "Country Name", "ISO_code" = "Country Code") %>%
  mutate_at(relevant_years, as.numeric) %>%
  select("ISO_code", relevant_years)


df_HDI_wide <- df_HDI_wide %>%
  select("Country", relevant_years) %>%
  mutate("ISO_code" = countrycode(Country, origin = "country.name", destination = "iso3c")) %>%
  mutate_at(relevant_years, as.numeric) %>%
  select("ISO_code", relevant_years)


df_country_info <- as.data.frame(df_country_info) %>% 
  rename("ISO_code" = "X.U.FEFF.iso_code", "region" = "Region", "income_group" = "IncomeGroup", "special_notes" = "SpecialNotes")


# retrieve common countries across data sets based on ISO code
common_ISO_codes <- Reduce(intersect, list(df_energy_long$ISO_code,df_life_wide$ISO_code, df_schooling_wide$ISO_code, 
                                           df_GDP_wide$ISO_code, df_population_wide$ISO_code, df_HDI_wide$ISO_code))

# filter data sets on common ISO codes
df_energy_long <- df_energy_long %>% filter(ISO_code %in% common_ISO_codes)
df_GDP_wide <- df_GDP_wide %>% filter(ISO_code %in% common_ISO_codes)
df_life_wide <- df_life_wide %>% filter(ISO_code %in% common_ISO_codes)
df_schooling_wide <- df_schooling_wide %>% filter(ISO_code %in% common_ISO_codes)
df_population_wide <- df_population_wide %>% filter(ISO_code %in% common_ISO_codes)
df_HDI_wide <- df_HDI_wide %>% filter(ISO_code %in% common_ISO_codes)
```


```{r}
# Convert data frames to long format
df_GDP_long <- df_GDP_wide %>% 
  pivot_longer(cols = -c("ISO_code"), names_to = "year", values_to = "GDP")
df_schooling_long <- df_schooling_wide %>% 
  pivot_longer(cols = -c("ISO_code"), names_to = "year", values_to = "years_of_schooling") %>%
  mutate_at("year", as.numeric)
df_life_long <- df_life_wide %>% pivot_longer(cols = -c("ISO_code"), names_to = "year", values_to = "life_expectancy")
df_population_long <- df_population_wide %>% 
  pivot_longer(cols = -c("ISO_code"), names_to = "year", values_to = "population") 
df_HDI_long <- df_HDI_wide %>% pivot_longer(cols = -c("ISO_code"), names_to = "year", values_to = "HDI")
```


```{r}
# merge data frames into one master data frame
master_df <- merge(df_energy_long, merge(df_GDP_long, merge(df_life_long, merge(df_schooling_long, merge(df_population_long, df_HDI_long,
                by = c("ISO_code", "year")), by = c("ISO_code", "year")), by = c("ISO_code", "year")), 
                by = c("ISO_code", "year")), by = c("ISO_code", "year"))

# Add one variable for country name and reorder columns
master_df <- master_df %>%
  mutate(country = countrycode(ISO_code, origin = "iso3c", destination = "country.name")) %>%
  select(ISO_code, country, year, population, GDP, HDI, life_expectancy, years_of_schooling, everything())
```

```{r}
# write master_df to csv
write.csv(master_df,"data/master.csv", row.names = FALSE)
```





<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

```{r, echo=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(patchwork)
library(Lock5withR)
library(ggpubr)
library(leaflet)
library(rgdal)
library(plotly)
source("R/plot_missing_patterns.R")
```

In this chapter, we **analyze the missing data in the merged master data frame**. We then dive into each of the primary sets to **understand why data is missing**, namely: energy consumption, GDP, life expectancy, years of schooling, and life expectancy.

## Missing values for the merged dataframe



```{r, fig.height=8}
# read master dataframe
master_df <- read.csv(file = "data/master.csv")
plot_missing_parameters(master_df, use_counts = FALSE, max_100 = TRUE, 
                        ticks_angle = 45, ticks_size = 9, complete_cases_size = 3.5, complete_cases_hjust = 0.1, y_ticks_size = 9)
```

Data sparsity is quite inconsistent across variables. We observe that **missing data mainly concerns energy related variables**. Hence, for a significant proportion of countries, it will be challenging to analyze the energy mix.

* * *

### Map of data availability across countries for all variables {.unlisted .unnumbered}

```{r, echo=FALSE}
# What countries have a high share of renewables today?
# Use 2019 percentage data
count_variables <- ncol(master_df) - 5

graph_df <- master_df %>%
  select(-c(country, year)) %>%
  group_by(ISO_code) %>%
  summarise(available_data =  1 - 1/((2019 - 1990 + 1) * count_variables) * (sum(is.na(coal)) + sum(is.na(fossil_fuel)) +
            sum(is.na(gas)) + sum(is.na(hydro)) + sum(is.na(low_carb)) + sum(is.na(nuclear)) + sum(is.na(oil)) +
            sum(is.na(other_renew)) + sum(is.na(renew)) + sum(is.na(solar)) + sum(is.na(wind)) + sum(is.na(biofuel)) +
            sum(is.na(HDI)) + sum(is.na(primary)) + sum(is.na(GDP)) + sum(is.na(years_of_schooling)) +
            sum(is.na(life_expectancy)) + sum(is.na(population)))) 
  

#Read shape file
world_spdf <- readOGR( 
  dsn= paste0(getwd(), "/R/world_shape_file"), 
  layer="TM_WORLD_BORDERS_SIMPL-0.3",
  verbose=FALSE
)

world_spdf@data = data.frame(world_spdf, graph_df[match(world_spdf$ISO3, graph_df$ISO_code),])

# Create a color palette for the map:
mybins <- rev(c(0.0,0.3,0.6,0.9,1.0))
mypalette <- colorBin( palette="RdYlGn", domain = graph_df$renew, na.color="#d3d3d3", bins=mybins)
labels <- c("90 - 100", "60 - 90", "30 - 60", "0 - 30", "not in dataset")

# Display map
leaflet(world_spdf) %>% 
  addTiles()  %>% 
  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( 
    fillColor = ~mypalette(available_data), 
    stroke=TRUE, 
    fillOpacity = 0.9, 
    color="white", 
    weight=0.3,
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"
    )
  ) %>%
  addLegend(pal=mypalette, values =~ available_data, opacity=0.9, title = "available data (%)", 
            position = "bottomleft", labFormat = function(type, cuts, p) {  # Here's the trick
                                                  paste0(labels)
                             })
```

<br>
At the intuition suggests, the **missing data is mainly located in central Africa**. By contrast, **Europe and North America countries all fall into the 90 to 100% range of data availability**.

* * *

## Dive into each primar dataset : understanding the missing values

### Energy consumption {.unlisted .unnumbered}

<u>Data description:</u> *Energy consumption of different countries by the type of energy production.*

[Link to data.](https://github.com/owid/energy-data)

We focus on the 1990-2020 time-frame.

```{r}
energy_data <- read.csv("data/owid_energy_data.csv", header=TRUE, stringsAsFactors=FALSE)
data_country_info <- read.csv("data/worldbank_country_info.csv", header=TRUE, stringsAsFactors=FALSE, encoding = "UTF-8")
df_country_info <- as.data.frame(data_country_info)
df_country_info <- as.data.frame(data_country_info) %>% 
  rename(iso_code = "X.U.FEFF.iso_code")
df_energy <- as.data.frame(energy_data)
selected_columns <- c("iso_code", "country", "year","consumption")
df_energy_sel <- df_energy %>% 
  select(contains(selected_columns)) %>%
  select(-contains(c("_per_capita", "_pct", "_change"))) %>%
  subset(year >= 1990) %>%
  rename("fossil_fuel" = "fossil_fuel_consumption", 
         "hydro" = "hydro_consumption", 
         "low_carb" = "low_carbon_consumption", 
         "nuclear" = "nuclear_consumption", 
         "other_renew" = "other_renewable_consumption", 
         "renew" = "renewables_consumption", 
         "solar" = "solar_consumption", 
         "wind" = "wind_consumption", 
         "coal" = "coal_consumption", 
         "gas" = "gas_consumption", 
         "oil" = "oil_consumption", 
         "biofuel" = "biofuel_consumption", 
         "primary" = "primary_energy_consumption")
  
plot_missing_parameters(df_energy_sel, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 9, complete_cases_size = 3.5, complete_cases_hjust = 0)
```

<u>Observations:</u>

- 40% of rows are missing 75% of the variables. This might become a problem when comparing countries over time as this might suggest that some countries have only little data for a limited number of years.
- 30% of rows are complete, such that the energy mix can be fully analyzed. 
- The remaining 30% of rows also miss a 56% to 81% of variables with some exceptions.

In order to have enough data to draw solid conclusions on these time series, we will probably have to select a sub-sample of countries.

Let's now group the countries together so as to visualize missing data by geographic region.


```{r}
# plot of missing data by geographic region
df_by_country <- df_energy_sel %>% mutate(missing_perc = rowSums(apply(is.na(df_energy_sel), 2, as.numeric))/ncol(df_energy_sel))
df_by_country <- df_by_country %>% filter(iso_code != "") %>% select(c(iso_code, country, year, missing_perc))
df_by_country <- left_join(df_by_country, df_country_info, by = "iso_code") %>%
  select(c(iso_code, country, year, missing_perc, Region, IncomeGroup)) %>%
  arrange(-missing_perc)
df_by_region <- df_by_country %>%
  select(c(Region, year, missing_perc)) %>%
  group_by(Region, year) %>%
  summarise(missing_perc = mean(missing_perc))
df_by_region <- df_by_region %>%
  ungroup() %>%
  mutate(fill_color = if_else(is.na(Region), TRUE, FALSE),
         Region = if_else(is.na(Region), "Unmatched countries", as.character(Region))) %>%
  group_by(Region) %>%
  mutate(mean_missing_perc = mean(missing_perc)) %>%
  ungroup()
df_by_region_order <- df_by_region %>%
  group_by(Region) %>%
  summarise(mean_missing = mean(missing_perc)) %>%
  arrange(desc(mean_missing), Region)
df_by_region$Region <- factor(df_by_region$Region, levels = df_by_region_order$Region)

cols <- c("mean value for missing data percentage"="black")

ggplot(df_by_region, aes(x=year, y=missing_perc*100, alpha = fill_color)) + 
  guides(size = "legend", alpha = "none") +
  geom_col(fill="#6495ED") + 
  ylim(0, 100) +
  geom_line(linetype = "longdash", aes(y = 100 * mean_missing_perc, colour = "mean value for missing data percentage"), size = 0.7) +
  facet_wrap(~Region) +
  scale_alpha_manual(values = c(1, 0.6)) +
  labs(x="Year", y="Missing data (in %)", title="Missing data by Geographic Region") +
  scale_colour_manual(name="",values=cols) +
  theme_classic() +
  theme(legend.position="bottom", panel.grid.major.y = element_line( size=.1, color="gray" ))
```

<u>Observations:</u>

- Sub-Saharan Africa and Latin America have the most missing data.
- Europe & central Asia, as well as North America have the least missing values.
- For all regions, data availability remains largely constant over time with a high spike in 2020, year for which the data might not be collected yet.
- For some countries, no region could be identified. This is indicated by the label "Unmatched countries". For better comparisons, these countries will be matched.

* * *

### GDP {.unlisted .unnumbered}

<u>Data description:</u> *Measure of a country's economic output computed by adding up the monetary value (in current $) of all finished goods and services made within a country for each year.*

[Link to data.](https://data.worldbank.org/indicator/NY.GDP.MKTP.CD)

We focus on the 1990-2019 time-frame.

```{r, fig.height=8}
# missing data plot for GDP
GDP <- read.csv("data/worldbank_GDP.csv", skip = 4, check.names = FALSE)
relevant_years <- as.character(1990:2019)
GDP <- GDP %>%
  select("Country Name", relevant_years)
myGDP <- GDP
names(myGDP) <- c("Country", substring(names(myGDP)[1:length(relevant_years) + 1], 0, 4))
plot_missing_parameters(data = myGDP, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 7.5, complete_cases_size = 3, complete_cases_hjust = 0.1, y_ticks_size = 7)
```
<u>Observations:</u>

- The highest sparsity is recorded for the most ancient years of the time frame. Data becomes increasingly unavailable as we go back in time.
- Complete cases account for almost 80% of the data. For all of these countries, the data gives a full picture of the evolution of GDP per capita across time.
- A small proportion of countries present a missing pattern of total unavailability of GDP per capita. The list of those countries is displayed just below. We see that these correspond to countries that either (1) do not share their data eg. Korea or (2) have a very small population and/or economic output eg. small islands like St.Martin.

```{r}
# table of countries with full missing pattern
prop_na <- GDP %>%
  mutate("NA_proportion" = apply(GDP, 1, FUN = function(x) sum(is.na(x))) / length(relevant_years)) %>%
  select("Country Name", "NA_proportion") %>%
  arrange(desc(NA_proportion)) %>%
  select("Country Name") %>%
  rename("Countries with full missing pattern" = "Country Name")

knitr::kable(head(prop_na, 5), "html")
```

* * *

### Life expectancy {.unlisted .unnumbered}

<u>Data description:</u> *Mean length of life of an actual birth cohort (all individuals born in a given year).*

[Link to data.](https://data.worldbank.org/indicator/SP.DYN.LE00.IN) 

We focus on the 1990-2019 time-frame.

```{r}
# missing data plot for life expectancy
un_life_data <- read.csv("data/life_expectancy.csv", skip = 4, check.names = FALSE)
relevant_years <- as.character(1990:2019)
un_life_data <- un_life_data %>%
  select("Country Name", relevant_years)
myun_life_data <- un_life_data
names(myun_life_data) <- c("Country", substring(names(myun_life_data)[1:length(relevant_years) + 1], 0, 4))
plot_missing_parameters(data = myun_life_data, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 7.5, complete_cases_size = 3, complete_cases_hjust = 0.05)
```

<u>Observations:</u>

- Life expectancy data becomes slightly sparser as we go back in time. However, the proportion of missing data stays within the range 6-8%.
- Complete cases account for almost 90% of the data. For all of these countries, the data gives a full picture of the evolution of life expectancy across time.
- The second most frequent missing pattern corresponds to total unavailability of life expectancy within the time frame. The list of those countries is displayed just below. We see that these correspond to either (1) unclassified data or (2) countries with very small population for which it is difficult to conduct data collection eg. small islands like American Samoa.

```{r}
# na proportion table
prop_na <- un_life_data %>%
  mutate("NA_proportion" = apply(un_life_data, 1, FUN = function(x) sum(is.na(x))) / length(relevant_years)) %>%
  select("Country Name", "NA_proportion") %>%
  arrange(desc(NA_proportion)) %>%
  select("Country Name") %>%
  rename("Countries with full missing pattern" = "Country Name")

knitr::kable(head(prop_na, 10), "html")
```

* * *

### Years of schooling {.unlisted .unnumbered}

<u>Data description:</u> *Number of years of schooling that a child of school entrance age can expect to receive if prevailing patterns of age-specific enrollment rates persist throughout the child's life.*

[Link to data.](http://hdr.undp.org/en/indicators/69706#) 

We focus on the 1990-2019 time-frame.

```{r}
# missing data plot for years of schooling
un_years_of_schooling <- read.csv("data/un_years_of_schooling.csv", skip = 6, check.names = FALSE)
relevant_years <- as.character(1990:2019)
un_years_of_schooling <- un_years_of_schooling %>%
  select("Country", "HDI Rank", relevant_years) %>%
  mutate_at(relevant_years, as.numeric) %>%
  mutate_at("HDI Rank", as.numeric)
myun_years_of_schooling <- un_years_of_schooling
plot_missing_parameters(data = myun_years_of_schooling, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 7.5, complete_cases_size = 3, complete_cases_hjust = 0.05)
```

<u>Observations:</u>

- As for previous variables, sparsity increases when we look at more ancient years, but never exceeds 12%. 
- Complete cases account for almost 90% of the data. For all of these countries, the data gives a full picture of the evolution of the years of schooling across time.
- A few countries are not ranked in terms of HDI. These countries are displayed below and correspond to countries that either (1) do not share their data eg. Korea or (2) countries with very small population (empirically < 40k) for which it is difficult to conduct data collection eg. Nauru.

```{r}
# countries with no HDI rank
no_hdi_rank <- un_years_of_schooling %>%
  filter(is.na(`HDI Rank` )) %>%
  select(Country)  %>%
  select("Country") %>%
  rename("Countries with no HDI rank" = "Country")

knitr::kable(head(no_hdi_rank), "html")
```

<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

```{r, echo=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(patchwork)
library(Lock5withR)
library(ggpubr)
library(stringr)
library(esquisse)
library(gganimate)
library(ggrepel)
library(GGally)
library(parcoords)
library(tools)
library(grid)
library(leaflet)
library(rgdal)
library(RColorBrewer)
library(plotly)
```

```{r echo=FALSE, warning=FALSE}
# Load Data
master_df <- read.csv(file = "data/master.csv")
# Load country info data
df_country_info <- read.csv("data/worldbank_country_info.csv", header=TRUE, stringsAsFactors=FALSE, encoding = "UTF-8") %>%
    rename(c(ISO_code = "X.U.FEFF.iso_code", region="Region", income_group="IncomeGroup")) %>%
    select(c("ISO_code", "region", "income_group"))

master_df <- left_join(master_df, df_country_info, by = "ISO_code")
```

```{r}
energy_vars <- c("fossil_fuel", "hydro", "low_carb", "nuclear", "other_renew", "renew", "solar", "wind", "coal", "gas", "oil", "biofuel", "primary")
distinct_energy_vars <- c("hydro", "nuclear", "solar", "wind", "coal", "gas", "oil", "biofuel", "other_renew")
```

## Cross directional causality btw. EC, GDP and YOS

The acronyms EC, GDP and YOS will be used to refer to energy consumption, gross domestic product and years of schooling respectively.

### Energy consumption fuels economic prosperity {.unlisted .unnumbered}

Analyzing the impact of energy consumption on GDP and mean years of schooling is not that easy as the three variables suffer from cross directional causality.
The intuition suggests a **high correlation between energy consumption and GDP**. Indeed, most economies are **highly energy dependent** and many production and consumption activities involve energy as a central input. 


```{r, fig.height=7, fig.width = 7}
# plot GDP per capita vs primary energy consumption per capita in 2019
master_df %>%
    filter(year == 2019) %>%
    ggplot(aes(x=primary/population, y=GDP/population)) +
    geom_point(aes(color = region, size = population, label = country)) +
    geom_smooth(method="lm", color = "black") +
    theme_light() +
    scale_x_log10(labels = function(l) {trans = l * 1000}) +
    scale_y_log10(labels = function(l) {trans = l / 1000}) +
    geom_text(
      aes(label=country), vjust = 2,
      size = 3,
      check_overlap = T
    ) +
    ggtitle("GDP per capita vs. primary energy consumption per capita in 2019") +
    xlab("Primary energy consumption per capita (MWh)") + 
    ylab("GDP per capita (k$)") +
    theme_classic() +
    theme(legend.position="bottom", legend.box = "vertical", 
          panel.grid.major.x = element_line( size=.1, color="gray" ),  
          panel.grid.major.y = element_line( size=.1, color="gray" )) +
    guides(colour = guide_legend(order = 1),
            size = guide_legend(order = 2),
           colour = guide_legend(override.aes = list(size=4)))
```


This graph emphasizes the intuitive idea that **energy is required to stimulate growth**. More consumption generally results in an increase in the economic output.

* * *

### Parallel increase of EC and YOS in economic growth  {.unlisted .unnumbered}

As a country benefits from economic prosperity with a higher GDP per capita, this one might allocate more resources to education to foster the formation of human capital. This would **enhance the schooling system and lead to the increase of the mean year of schooling** for a given cohort.


```{r, fig.width = 7}
# plot GDP per capita vs primary energy consumption per capita in 2019
master_df %>%
    filter(country %in% c("Brazil", "Russia", "India", "China")) %>%
    ggplot(aes(x=primary/population, y=years_of_schooling, group = country, colour = country)) +
    geom_point(aes(label = year)) +
    geom_path(size = 1,
              arrow = arrow(type = "open", angle = 30, length = unit(0.15, "inches"))) +
    theme_light() +
    scale_x_log10(labels = function(l) {trans = l * 1000}) +
    ggtitle("Mean years of schooling vs. primary energy consumption per capita \n for BRIC countries over 1990-2019") +
    xlab("Primary energy consumption per capita (MWh)") + 
    ylab("Expected years of schooling at birth (years)") +
    theme_classic() +
    theme(legend.position="bottom", legend.box = "vertical", 
          panel.grid.major.x = element_line( size=.1, color="gray" ),  
          panel.grid.major.y = element_line( size=.1, color="gray" )) +
    guides(colour = guide_legend(order = 1),
           colour = guide_legend(override.aes = list(size=4))) +
  scale_colour_discrete(limits = c("Brazil", "Russia", "India", "China"))
```

```{r, fig.width = 7}
# plot GDP per capita vs primary energy consumption per capita in 2019
master_df %>%
    filter(country %in% c("United States", "Canada", "Japan", "France", "Germany")) %>%
    ggplot(aes(x=primary/population, y=years_of_schooling, group = country, colour = country)) +
    geom_point(aes(label = year)) +
    geom_path(size = 1,
              arrow = arrow(type = "open", angle = 30, length = unit(0.15, "inches"))) +
    theme_light() +
    scale_x_log10(labels = function(l) {trans = l * 1000}) +
    ggtitle("Mean years of schooling vs. primary energy consumption per capita \n for most developed countries over 1990-2019") +
    xlab("Primary energy consumption per capita (MWh)") + 
    ylab("Expected years of schooling at birth (years)") +
    theme_classic() +
    theme(legend.position="bottom", legend.box = "vertical", 
          panel.grid.major.x = element_line( size=.1, color="gray" ),  
          panel.grid.major.y = element_line( size=.1, color="gray" )) +
    guides(colour = guide_legend(order = 1),
           colour = guide_legend(override.aes = list(size=4))) +
  scale_colour_discrete(limits = c("United States", "Canada", "Japan", "France", "Germany")) 
  
```

```{r,  fig.width = 7}
# plot GDP per capita vs primary energy consumption per capita in 2019 for the two groups of countries
master_df %>%
    filter(country %in% c("United States", "Canada", "Japan", "France", "Germany", "Brazil", "Russia", "India", "China")) %>%
    mutate(category = if_else(country %in% c("Brazil", "Russia", "India", "China"), "BRIC", "mature")) %>%
    ggplot(aes(x=primary/population, y=years_of_schooling, group = country, colour = category)) +
    geom_point(aes(label = year)) +
    geom_hline(yintercept = 15.0, color = "black", size = 0.5) +
    geom_hline(yintercept = 17.0, color = "black", size = 0.5) +
    annotate("rect", fill = "grey", alpha = 0.4, 
        xmin = 0.000, xmax = Inf, ymin = 15, ymax = 17) +
    annotate("text", x = 0.000005, y = 16, label = "YOS at maturity") +
    geom_path(size = 0.2) +
    theme_light() +
    geom_point(aes(group = seq_along(year))) +
    transition_reveal(year) +
    scale_x_log10(labels = function(l) {trans = l * 1000}) +
    ggtitle("Mean years of schooling vs. primary energy consumption per capita \n for BRIC and most developed countries over 1990-2019") +
    xlab("Primary energy consumption per capita (MWh)") + 
    ylab("Expected years of schooling at birth (years)") +
    theme_classic() +
    theme(legend.position="bottom", legend.box = "vertical", legend.title = element_blank(),
          panel.grid.major.x = element_line( size=.1, color="gray" ),  
          panel.grid.major.y = element_line( size=.1, color="gray" )) +
    guides(colour = guide_legend(order = 1),
           colour = guide_legend(override.aes = list(size=4))) +
  scale_color_manual(labels = c("BRIC : Brazil, Russia, India and China", "Mature countries : United States, Canada, Japan, France, Germany"), values=c("black", "#E69F00"))
```

The path towards economic maturity consists of a **simultaneous rise of energy consumption and mean years of schooling**. To become more productive, a country invests in education in order for its proportion of educated workers to increase. On the plot just above, we notice that **the expect years of schooling seems to converge towards a value between 15 and 17 years, value that we observe for mature countries**.

* * *

## Co-movement of energy consumption and HDI

### An overview of HDI in the world {.unlisted .unnumbered}

```{r, echo=FALSE}
# What countries have a high share of renewables today?
# Use 2019 percentage data
graph_df <- master_df

#Read shape file
world_spdf <- readOGR( 
  dsn= paste0(getwd(), "/R/world_shape_file"), 
  layer="TM_WORLD_BORDERS_SIMPL-0.3",
  verbose=FALSE
)

world_spdf@data = data.frame(world_spdf, graph_df[match(world_spdf$ISO3, graph_df$ISO_code),])

# Create a color palette for the map:
mybins <- rev(c(0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0))
mypalette <- colorBin( palette="RdYlGn", domain = graph_df$renew, na.color="#d3d3d3", bins=mybins)

# Display map
leaflet(world_spdf) %>% 
  addTiles()  %>% 
  setView( lat=10, lng=0 , zoom=2) %>%
  addPolygons( 
    fillColor = ~mypalette(HDI), 
    stroke=TRUE, 
    fillOpacity = 0.9, 
    color="white", 
    weight=0.3,
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"
    )
  ) %>%
  addLegend(pal=mypalette, values=~HDI, opacity=0.9, title = "HDI", position = "bottomleft" )
```
</br>
From the available data, we observe **high variability of the human development index**. It ranges from the highest values in Europe, North America, Oceania and Japan to the lowest in central Africa.

* * *

### Segmented analysis of HDI {.unlisted .unnumbered}

The increase of energy consumption of a population generally tends to affect its way of living. The intuition suggests that, in the long-term, consuming more energy is correlated with an improvement of the the human development of a population and hence, an increase of the HDI.


```{r, fig.height=7, fig.width = 7}
# energy consumption per capita threshold for segmented regression
log_pcpc_sep <- 3.5e-5

regression_data_inf <- master_df %>%
    filter(year == 2019, primary/population <= log_pcpc_sep) %>%
    mutate(log_ratio_primary_population = log10(primary/population))

regression_data_sup <- master_df %>%
    filter(year == 2019, primary/population > log_pcpc_sep) %>%
    mutate(log_ratio_primary_population = log10(primary/population))

lm_inf <- lm(data = regression_data_inf, HDI ~ log_ratio_primary_population)
lm_sup <- lm(data = regression_data_sup, HDI ~ log_ratio_primary_population)

r_squared_inf <- summary(lm_inf)$r.squared
r_squared_sup <- summary(lm_sup)$r.squared

# plot HDI vs primary energy consumption per capita in 2019
master_df %>%
    filter(year == 2019) %>%
    ggplot(aes(x=primary/population, y=HDI)) +
    geom_point(aes(color = region, size = population, label = country)) +
    geom_vline(xintercept = log_pcpc_sep, linetype = "dashed") +
    geom_smooth(data = subset(master_df, 2e-6 < primary/population & primary/population < log_pcpc_sep), method="lm", color = "black") +
    geom_smooth(data = subset(master_df, primary/population > log_pcpc_sep), method="lm", color = "black") +
    theme_light() +
    scale_x_log10(labels = function(l) {trans = l * 1000}) +
    scale_y_log10() +
    geom_text(
      aes(label=country), vjust = 2,
      size = 3,
      check_overlap = T
    ) +
    annotate("text", x = 0.00002, y= 0.55, label=paste("R^2 == ", round(r_squared_inf, digits = 2)), parse = T) +
    annotate("text", x = 0.0002, y= 0.55, label=paste("R^2 == ", round(r_squared_sup, digits = 2)), parse = T)  +
    ggtitle("HDI vs. Primary energy consumption per cap. in 2019") +
    xlab("Primary energy consumption per capita (MWh)") + 
    ylab("HDI") +
    theme_classic() +
    theme(legend.position="bottom", legend.box = "vertical", 
          panel.grid.major.x = element_line( size=.1, color="gray" ),  
          panel.grid.major.y = element_line( size=.1, color="gray" )) +
    guides(colour = guide_legend(order = 1),
            size = guide_legend(order = 2),
           colour = guide_legend(override.aes = list(size=4)))
```

There seems to be a **threshold of energy consumption per capita which separates two types of HDI behaviors**. For countries with low level of energy consumption, the **causal relationship between energy consumption and HDI is very strong**, as suggested by the high value of $R^2$. By contrast, there does not seem to be a correlation for countries with high level of energy consumption. Intuitively, the investments made by a country on the verge of becoming wealthier will generally have a **much larger effect on human development** (health system, education).

* * *

## Association of Human Development and Renewable Energy 

The earlier analysis of GDP and energy consumption shows that economic growth, energy consumption, and human development are correlated until a threshold on the economic growth is reached. Considering the growing importance of renewable energy and the negative effects fossil energy sources can have on human livelihood, we must understand the **relation of renewable energy and human development**.
```{r}
graph_df <- master_df[master_df$year==2019 & master_df$country != "Iceland"  & master_df$country != "Norway",]

# Create graph for MWh of renewable energy per capita 
p1 <- ggplot(graph_df, aes(x=renew/population*1000000000, y=HDI)) +
  geom_point(aes(color = region)) +
  geom_smooth(method="lm") +
  theme_classic() + 
  theme(legend.position="none") +
  geom_text(
    label=graph_df$country, 
    nudge_x = 0, nudge_y = 0.02,
    size = 3,
    check_overlap = T
  ) +
  scale_x_log10() +
  labs(x="Renewable energy consumption\nper capita (MWh)", y="HDI", color="Region", caption = " ")

# Create graph for renewable energy share of total energy consumption
p2 <- ggplot(graph_df, aes(x=renew/primary*100, y=HDI)) +
  geom_point(aes(color = region)) +
  geom_smooth(method="lm") +
  theme_classic() + 
  theme(legend.position="none") +
  geom_text(
    label=graph_df$country, 
    nudge_x = 0, nudge_y = 0.02,
    size = 3,
    check_overlap = T
  ) +
  labs(x="Share of renewables to \n overall energy consumption (%)", y="", color="Region", caption = "Extreme outliers were removed.")

# function to only grab the legend from a graph
get_only_legend <- function(plot) { 
  plot_table <- ggplot_gtable(ggplot_build(plot))  
  legend_plot <- which(sapply(plot_table$grobs, function(x) x$name) == "guide-box")
  legend <- plot_table$grobs[[legend_plot]] 
  return(legend)  
}

# Grab legend from first plot for final combined plot
p1_legend <- ggplot(graph_df, aes(x=renew/primary*100, y=HDI)) +
  geom_point(aes(color = region)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(color="Region")

# Combine plots and legend
legend <- get_only_legend(p1_legend)
combined_plot <- gridExtra::arrangeGrob(p1, p2, ncol=2)
gridExtra::grid.arrange(combined_plot, legend, nrow=2, heights = c(9, 2), top = textGrob("HDI score vs. renewable energy consumption per capita \n and as share of overall energy consumption in 2019"))
```
</br>
There is both a **positive correlation between HDI and renewable energy consumption** both in per capita and in relative terms. However, we can also see that countries with a low share of renewable energy consumption like Hong Kong or Australia achieve high levels of human development. Moreover, does the plot on the left support the fact that higher overall energy consumption correlates with human development. Nevertheless, we can deduct that more developed countries also invest more in renewable energy.

```{r, fig.height=4}
perct_df <- master_df
perct_df[energy_vars] <- (perct_df[energy_vars] / rowSums(perct_df[distinct_energy_vars])) * 100
perct_df_2019 <- perct_df[perct_df$year==2019,]

graph_df <- perct_df_2019 %>% rename("Life expectancy"="life_expectancy", "Years of schooling"="years_of_schooling", "Renewables share"="renew")

# Function to add smooting lines to scatter matrix
scat_mat_lr <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point() + 
    geom_smooth(method=lm, fill="blue", color="blue", ...)
  p
}

ggpairs(graph_df, columns = c(6, 7, 8, 14), lower = list(continuous = scat_mat_lr)) +
  labs(title = "Human development metrics and renewable energy in 2019") + 
  theme_classic() +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))
```
</br>
Statistically significantly more countries with a high share of renewable energy are also those countries in which citizens have a higher life expectancy and tend to receive more education. While life expectancy is left-skewed and years of schooling is normally distributed, the share of renewables is strongly right-skewed. This indicates great room for improvement in investments into renewable energy.

* * *

## Characteristics of Countries With a High Share of Renewable Energy 
*(There is no data on renewable energy available for 91 countries. These countries are mainly in Africa.)*

Now, we want to analyse countries have a high share of renewable energy and what differentiates them from the rest of the world.

**Countries and the Share of Renewable Energy in Their Energy Mixes**
```{r}
# What countries have a high share of renewables today?
# Use 2019 percentage data
graph_df <- perct_df_2019

#Read shape file
world_spdf <- readOGR( 
  dsn= paste0(getwd(), "/R/world_shape_file"), 
  layer="TM_WORLD_BORDERS_SIMPL-0.3",
  verbose=FALSE
)

world_spdf@data = data.frame(world_spdf, graph_df[match(world_spdf$ISO3, graph_df$ISO_code),])

# Create a color palette for the map:
mybins <- c(100,80, 60, 40, 30, 20, 10, 5)
mypalette <- colorBin(palette="Greens", domain = graph_df$renew, na.color="#d3d3d3", bins=mybins)
legend_text <- c("80 - 100", "60 - 80", "40 - 60", "30 - 40", "10 - 20", "5 - 10", "0 - 5", "No data available")

# Prepare the text for tooltips
labels <- lapply(seq(nrow(world_spdf@data)), function(i){
  if(is.na(world_spdf@data$renew[i])){
    paste(
      "<b>", "Country: ", world_spdf@data$country[i],"</b>", 
      sep="")
  } else {
    paste(
      "<b>", "Country: ", world_spdf@data$country[i],"</b>","<br/>", 
      "Renewables: ", round(world_spdf@data$renew[i], 1), "%<br/>", 
      "Fossil Fuels: ", round(world_spdf@data$fossil_fuel[i], 1), "%<br/>", 
      "Nuclear: ", round(world_spdf@data$nuclear[i], 1), "%",
      sep="")
  }
})

# Display map
m <- leaflet(world_spdf) %>% 
  addTiles()  %>% 
  setView( lat=20, lng=0 , zoom=1.5) %>%
  addPolygons( 
    fillColor = ~mypalette(renew), 
    stroke=TRUE, 
    fillOpacity = 0.9, 
    color="#444444", 
    weight=0.3,
    label = lapply(labels, htmltools::HTML),
    labelOptions = labelOptions( 
      style = list("font-weight" = "normal", padding = "3px 8px"), 
      textsize = "13px", 
      direction = "auto"
    ),
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE)
  ) %>%
  addLegend(pal=mypalette, values=~(-renew), opacity=0.9, title = "Renewables (%)", position = "bottomleft", 
            labFormat = function(type, cuts, p){paste0(legend_text)})

m 
```
</br>
The countries with the highest share of renewable energy are Iceland, Norway, and Brazil. These and many other countries that have a high share of renewable energy have a long shoreline compared to the countries' sizes.

* * *
```{r}
# What is the energy mix of the most renewable countries?
graph_df <- master_df %>% filter(year==2019) %>%
  arrange(desc(renew/primary)) %>% slice(1:10) %>% 
  select(-c("primary", "fossil_fuel", "renew")) %>% 
  pivot_longer(distinct_energy_vars, names_to = "energy") %>%
  mutate(value_per_capita = value / population * 1000000) %>%
  mutate(energy = sub("other_renew", "Other Renewables", energy)) %>%
  mutate(energy = sub("hydro", "Hydropower", energy)) %>%
  mutate(energy = toTitleCase(energy))
levels <- names(sort(tapply(graph_df$value_per_capita, graph_df$energy, sum)))

ggplot(graph_df, aes(x=reorder(country, -value_per_capita), y=value_per_capita, fill=factor(energy, levels=levels))) +
  geom_bar(stat="identity") +
  theme_classic() + 
  theme(panel.grid.major.y = element_line()) + 
  theme(axis.text = element_text(angle = 45, vjust = 0, hjust = 1)) +
  scale_fill_manual(values=c("#eabc35", "#8d9e2b", "#7cabcb", "#645f55", "#c0b879", "#d0d890", "#b18781", "black", "#1e7991")) +
  labs(y="Energy mix per capita (MWh)", x="Country", fill="Energy source", title="Energy mixes of the 10 most renewable countries")
```
</br>
The most renewable countries rely on hydropower but also oil for a large share of their per capita energy consumption. While it is commonly assumed that renewable energies cannot reliably service a large energy demand, the example of Iceland indicates that this is must not be true (of course considering political and geographical circumstances). Brazil and Ecuador are two poorer countries than the rest but manage to achieve a high share of renewable energy, further indicating that sustainable energy consumption is not only achievable for rich nations.    

* * *
```{r}
# Calculate average energy mix of top 10 most renewable countries and compare to the rest of the world

# Create dataframe for weighted average of energy of top 10 most renewable countries
top_ten_df <- perct_df_2019 %>% 
  arrange(desc(renew/primary)) %>% 
  slice(1:10) %>% 
  select(-c("primary", "fossil_fuel", "renew")) %>%
  pivot_longer(distinct_energy_vars, names_to = "energy") %>%
  group_by(energy) %>%
  summarise(value = sum(value)) %>%
  mutate(value = value/sum(value)) %>%
  mutate(name = "Top ten")

# Create dataframe for weighted average of energy rest of the world
average_df <- perct_df_2019 %>% 
  arrange(desc(renew/primary)) %>% 
  slice(11:nrow(.)) %>% 
  select(-c("primary", "fossil_fuel", "renew")) %>%
  pivot_longer(distinct_energy_vars, names_to = "energy") %>% drop_na(value) %>%
  group_by(energy) %>%
  summarise(value = mean(value)) %>%
  mutate(value = value/sum(value)) %>%
  mutate(name = "World average")

# Bind average_df and top_ten_df and rename values to have one graph to plot
graph_df <- rbind(top_ten_df, average_df) %>%
  mutate(energy = sub("other_renew", "Other Renewables", energy)) %>%
  mutate(energy = sub("hydro", "Hydropower", energy)) %>%
  mutate(energy = toTitleCase(energy))

# Plot Bar chart comparing the percentage energy of top ten ad rest of the world
ggplot(graph_df, aes(x=factor(name, levels=c("Top ten", "World average")), y=value, fill=factor(energy, levels=levels))) +
  geom_bar(stat="identity") +
  theme_classic() + 
  theme(panel.grid.major.y = element_line()) +
  geom_text(aes(label = paste0(round(value, 3)*100,"%")),
            position = position_stack(vjust = 0.5), size = 3, color="#ffffff", check_overlap = T) +
  scale_fill_manual(values=c("#eabc35", "#8d9e2b", "#7cabcb", "#645f55", "#c0b879","#d0d890", "#b18781", "black", "#1e7991")) +
  labs(y="Energy mix (%)", x="", fill="Energy source", title="Comparison of the energy mix of the most renewable countries\nand the rest of the world in 2019")
```
</br>
The **major difference** between the top ten countries and the rest of the world **is the share of hydropower**. It is 23% higher than the one of the rest of the world. Additionally, the **top ten countries use 24.6% less coal** in their energy mix. Interestingly, **wind, biofuel, and solar make up a very small share of the energy mix in all countries** despite them being the ones that many countries put the most political attention to. 

```{r}
# How does the share of renewable energy change in different countries?
graph_df <- master_df %>% filter(!is.na(renew))
graph_df$income_group[graph_df$country=="Venezuela"] <- "Lower middle income"
graph_df <- graph_df %>%
  group_by(income_group, year) %>% 
  summarise(renew = sum(renew), total = sum(primary)) %>%
  mutate(renew = renew / total*100) %>%
  mutate(income_group = factor(income_group, levels=c("High income", "Upper middle income", "Lower middle income")))
  
ggplot(graph_df, aes(x=year, y=renew, group=income_group, color=income_group)) +
  geom_line(key_glyph="timeseries", size=1) +
  theme_classic() +
  theme(panel.grid.major.y = element_line(), legend.position="bottom") +
  labs(x="Year", 
       y="Share of renewable energy (in %)", 
       color="Income Groups", 
       caption="No data available for lowest income", 
       title="Weighted average growth of renewable energy by income group over 1990-2019") +
  scale_colour_discrete(labels = c('High income\n(>12,535 USD)', 
                                   'Upper middle income\n(4,046 - 12,535 USD)', 
                                   'Lower middle income\n(1,036- 3,995 USD)'))
```
</br>
Contrary, to common expectation, **not the richest countries but upper middle income countries grow their renewable energy quickest**. Instead, populous upper middle income countries like Brazil, Turkey, and China, drive steeper growth. Nevertheless, many upper-middle income countries do not currently increase their share of renewable energy. Albeit the average growth is slightly slower for high income countries, **growth is more consistent across high income countries**. An upward trend for all high-income trend could be identified. Lower middle income countries have only seen a slight uptick in recent years. On the one hand, countries like India and Venezuela slowly drive up the share of renewables. On the other hand, **countries like Pakistan, Vietnam, or Sri Lanka have recently seen their renewable energy share drop drastically**.

* * *

This concludes the results of our analysis. In the next chapter we will interpret the data to answer the initially proposed questions.

<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component

```{r, echo=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
```

```{r echo=FALSE, warning=FALSE}
# Load Data
master_df <- read.csv(file = "data/master.csv")
distinct_energy_vars <- c("hydro", "nuclear", "solar", "wind", "coal", "gas", "oil", "biofuel", "other_renew")

left_df <- master_df %>%
  select(c("ISO_code", "year", "HDI", "solar", "biofuel", "wind", "coal", "nuclear", "other_renew", "gas", "oil", "hydro")) %>%
  na.omit()

right_df <- left_df[left_df$year==2019,] %>% select(c("ISO_code", "HDI"))

interactive_df <- left_join(left_df, right_df, by="ISO_code") %>%
  mutate(HDI = HDI.y) %>%
  select(-c("HDI.x", "HDI.y")) %>%
  mutate(HDI = case_when(HDI <= 0.549 ~ 'Low',
                         (HDI <= 0.699 & HDI > 0.549) ~ 'Medium',
                         (HDI <= 0.799 & HDI > 0.699) ~ 'High',
                         (HDI <= 1 & HDI > 0.799) ~ 'Very high')) %>%
  select(-"ISO_code") %>%
  group_by(year, HDI) %>%
  summarise_all(list(sum)) %>%
  rename(Year="year", Solar="solar", Biofuel="biofuel", Wind="wind",
         Coal="coal", Nuclear="nuclear", 
         "Other_renewables"="other_renew", Gas="gas", Oil="oil",
          Hydropower="hydro")

write.csv(interactive_df,"data/interactive6.csv", row.names = FALSE)
```



<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion

In conclusion, the study of human development and energy consumption is insightful and very relevant. Understanding how education, life expectancy, wealth, overall energy consumption, and the shift to renewable energies relate to each other today, is relevant to make decisions on how we shape future societies. Future societies that will consume more energy and rely on more renewable energy without sacrificing quality of life.

## Answers
**How is the increase in energy consumption boosting the education system in order to cope with theindustrial ”boom” generated by rapid economic growth?**
..human development indicator (HDI)

**What are the most important factor that determine how a variation of energy consumption affect the human development index of a country?**

**Is the rate at which the HDI increases with respect to energy consumption constant, or does it start to decrease after a specific GDP per capita?**

**Is an energy mix oriented towards renewable sources associated with good human development indicators?**
Yes, countries that have a high share and consumption of renewable energy are perform better in the categories of the HDI. Countries are richer and people get education and live longer. while a strong causation in this relationship is unlikely as GDP is a strong confounding variable, we do see that those countries with high renewable energy exceed those countries that match their wealth but not their renewable energy sourcing.

**What characterises the countries that have the most renewable energy mix?**
Countries with a highly renewable energy mix, get a high share of their energy from hydropower but also still require large amounts of oil. Other countries should investigate the possibility of hydropower energy more closely where possible. Additionally, the case of Iceland also suggests that even very high energy consumption, that is likely in more countries in the future, can be serviced by a highly renewable energy grid.
Both high income and upper middle income countries currently grow their share of renewable energy quickly, indicating that not only *the* richest countries can make their energy mix more sustainable. However, this does not neglect the fact that wealthier countries have more capacity to invest in renewables and that developing countries might need support in this area.

## Summary
In our report, we found out how that while economic growth and better living standards are associated with higher energy consumption, this resource-driven growth stagnates at a certain level and that other measures need to be found for further growth. This fact encourages the idea that we should not only increase consumption and economic production further but also consider other measures to effectively improve education and life expectancy. Instead, nations can invest in greener technologies like Iceland, New Zealand, or Norway to grow beyond the limitations that the simple GDP-energy relation faces at some point.

<!--chapter:end:07-conclusion.Rmd-->

