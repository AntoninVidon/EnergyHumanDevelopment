---
output:
  html_document: default
  pdf_document: default
---
# Missing values

```{r, echo=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(patchwork)
library(Lock5withR)
library(ggpubr)
source("R/plot_missing_patterns.R")
```

In this chapter, we analyze the missing data in our four primary data sets on energy consumption, GDP, life expectancy, years of schooling, and life expectancy.

## Energy consumption

```{r}
energy_data <- read.csv("data/owid_energy_data.csv", header=TRUE, stringsAsFactors=FALSE)
data_country_info <- read.csv("data/worldbank_country_info.csv", header=TRUE, stringsAsFactors=FALSE, encoding = "UTF-8")
df_country_info <- as.data.frame(data_country_info)
df_country_info <- as.data.frame(data_country_info) %>% 
  rename(iso_code = "X.U.FEFF.iso_code")
df_energy <- as.data.frame(energy_data)
selected_columns <- c("iso_code", "country", "year","consumption")
df_energy_sel <- df_energy %>% 
  select(contains(selected_columns)) %>%
  select(-contains(c("_per_capita", "_pct", "_change"))) %>%
  subset(year >= 1990) %>%
  rename("fossil_fuel" = "fossil_fuel_consumption", 
         "hydro" = "hydro_consumption", 
         "low_carb" = "low_carbon_consumption", 
         "nuclear" = "nuclear_consumption", 
         "other_renew" = "other_renewable_consumption", 
         "renew" = "renewables_consumption", 
         "solar" = "solar_consumption", 
         "wind" = "wind_consumption", 
         "coal" = "coal_consumption", 
         "gas" = "gas_consumption", 
         "oil" = "oil_consumption", 
         "biofuel" = "biofuel_consumption", 
         "primary" = "primary_energy_consumption")
  
plot_missing_parameters(df_energy_sel, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 9, complete_cases_size = 3.5, complete_cases_hjust = 0)
```

We can see that about 40% of rows are missing almost all variables. This might become a problem when comparing countries over time as this might suggest that some countries have only little data for a limited number of years.
However, about 35% of rows are complete, in that the energy mix can be fully analyzed. The remaining 30% of rows also miss a high share of variables with some exception for oil, biofuel, and primary energy consumption. The reasons for this will need to be examined.

Now, we calculate the share of all missing data to the overall dataset to get a sense of the magnitude.
```{r}
# Calculate share of missing data in total
perc_missing <- round(sum(is.na(df_energy_sel)) * 100 / prod(dim(df_energy_sel)), 1)
cat(perc_missing, "% of cell values is missing", sep="")
```

With such a high value, we know that we will need to reduce our analysis to some subset of rows to make many meaningful analyses. Second, we calculate the missing data on a column basis.
```{r}
# Calculate share of missing data per column
df_energy_na <- as.data.frame(round(colSums(is.na(df_energy_sel)) / nrow(df_energy_sel) * 100, 1)) %>% 
  rename(perc_na = 1) %>%
  mutate(variable = rownames(.)) %>%
  arrange(-perc_na)
ggplot(df_energy_na, aes(x=reorder(variable, perc_na), y=perc_na)) + 
  geom_col() +
  labs(x="Variable", y="Missing data (in percent)", title="Missing data per column") +
  coord_flip()
```

We look at the same visualization on a by-region basis. To identify a country's region, we merge the energy data set with the worldbank data set on countries.
```{r}
df_by_country <- df_energy_sel %>% mutate(missing_perc = rowSums(apply(is.na(df_energy_sel), 2, as.numeric))/ncol(df_energy_sel))
df_by_country <- df_by_country %>% filter(iso_code != "") %>% select(c(iso_code, country, year, missing_perc))
df_by_country <- left_join(df_by_country, df_country_info, by = "iso_code") %>%
  select(c(iso_code, country, year, missing_perc, Region, IncomeGroup)) %>%
  arrange(-missing_perc)
df_by_region <- df_by_country %>%
  select(c(Region, year, missing_perc)) %>%
  group_by(Region, year) %>%
  summarise(missing_perc = mean(missing_perc))
df_by_region_order <- df_by_region %>%
  group_by(Region) %>%
  summarise(mean_missing = mean(missing_perc)) %>%
  arrange(desc(mean_missing), Region)
df_by_region$Region <- factor(df_by_region$Region, levels = df_by_region_order$Region)
plt_available_years_by_region <- ggplot(df_by_region, aes(x=year, y=missing_perc)) + 
  geom_col() + 
  ylim(0, 1) +
  facet_wrap(~Region) +
  labs(x="Year", y="Missing data (in percent)", title="Missing Data by Geographic Region")
plt_available_years_by_region
```

On a region-basis, we can see that Sub-Saharan Africa and Latin America have the most missing data, while Europe & central Asia, as well as North America have the least missing values. For all regions, data availability remains largely constant over time with a high spike in 2020. This is likely due to recency and that some data is not finally collected yet. We also see that because of the merge some countries were not matched with a region in the last graph "NA". Looking at these countries individually, we will be able to match them with the fitting region.

Now we look at the missing data on a by-country basis.

```{r, fig.height=30, fig.width=15}
df_by_country_order <- df_by_country %>%
  group_by(country, Region) %>%
  summarise(sum_missing = sum(missing_perc))
df_by_country_order <- df_by_country_order %>% arrange(desc(sum_missing), Region)
order_country <- df_by_country_order$country
df_by_country$country <- factor(df_by_country$country, levels = order_country)
plt_available_years_by_country <- ggplot(df_by_country, aes(x=year, y=missing_perc, color=Region)) + 
  geom_col() + 
  ylim(0, 1) +
  facet_wrap(~country, ncol = 7) +
  theme(axis.text.x = element_text(angle = 20, hjust = 1, size = 7)) +
  labs(x="Year", y="Missing Data (in percent)", title="Missing Data by Country and Region")
plt_available_years_by_country
```

Looking at the missing data by country, it becomes clear that many countries missing specific variables over the entire time frame. The data availability is also constant inside the previously looked at regions. While the data availability in European and North American countries is largely consistent, the countries in East Asia & Pacific and Latin America vary widely. Some of them are among the best in terms of data availability while others are among the worst. We predict a strong correlation with GDP which will be test later.


## GDP per capita

<u>Data description:</u> *Measure of a country's economic output per person calculated by dividing the GDP of a country by its population.*

[Link to data.](https://data.worldbank.org/indicator/NY.GDP.PCAP.CN)

We focus on the 1990-2019 time-frame.

```{r}
gdp_per_capita <- read.csv("data/gdp_per_capita.csv", skip = 4, check.names = FALSE)
relevant_years <- as.character(1990:2019)
gdp_per_capita <- gdp_per_capita %>%
  select("Country Name", relevant_years)
mygdp_per_capita <- gdp_per_capita
names(mygdp_per_capita) <- c("Country", substring(names(mygdp_per_capita)[1:length(relevant_years) + 1], 0, 4))
plot_missing_parameters(data = mygdp_per_capita, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 7.5, complete_cases_size = 2, complete_cases_hjust = 0.05, y_ticks_size = 6)
```
<u>Observations:</u>

- The highest sparsity is recorded for the most ancient years of the time frame. Data becomes increasingly unavailable as be go back in time.
- Complete cases account for almost 80% of the data. For all of these countries, the data gives a full picture of the evolution of GDP per capita across time.
- A small proportion of country present a missing pattern of total unavailability of GDP per capita. The list of countries is displayed just below. We see that these correspond to countries that either (1) do not share their data eg. Korea or (2) have a very small population and/or economic output eg. small islands like St.Martin or.

```{r}
prop_na <- gdp_per_capita %>%
  mutate("NA_proportion" = apply(gdp_per_capita, 1, FUN = function(x) sum(is.na(x))) / length(relevant_years)) %>%
  select("Country Name", "NA_proportion") %>%
  arrange(desc(NA_proportion)) %>%
  select("Country Name") %>%
  rename("Countries with full missing pattern" = "Country Name")

knitr::kable(head(prop_na, 5), "html")
```

## Life expectancy

<u>Data description:</u> *Mean length of life of an actual birth cohort (all individuals born in a given year).*

[Link to data.](https://data.worldbank.org/indicator/SP.DYN.LE00.IN) 

We focus on the 1990-2019 time-frame.

```{r}
un_life_data <- read.csv("data/life_expectancy.csv", skip = 4, check.names = FALSE)
relevant_years <- as.character(1990:2019)
un_life_data <- un_life_data %>%
  select("Country Name", relevant_years)
myun_life_data <- un_life_data
names(myun_life_data) <- c("Country", substring(names(myun_life_data)[1:length(relevant_years) + 1], 0, 4))
plot_missing_parameters(data = myun_life_data, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 7.5, complete_cases_size = 3, complete_cases_hjust = 0.05)
```

<u>Observations:</u>

- Life expectancy data becomes slightly sparser as we go back in time. However, the range of missing data stays within the range 6-8%.
- Complete cases account for almost 90% of the data. For all of these countries, the data gives a full picture of the evolution of life expectancy across time.
- The second most frequent missing pattern corresponds to total unavailability of life expectancy within the time frame. The list of countries is displayed just below. We see that these correspond to either (1) unclassified data or (2) countries with very small population for which it is difficult to conduct data collection eg. small islands like American Samoa.

```{r}
prop_na <- un_life_data %>%
  mutate("NA_proportion" = apply(un_life_data, 1, FUN = function(x) sum(is.na(x))) / length(relevant_years)) %>%
  select("Country Name", "NA_proportion") %>%
  arrange(desc(NA_proportion)) %>%
  select("Country Name") %>%
  rename("Countries with full missing pattern" = "Country Name")

knitr::kable(head(prop_na, 10), "html")
```

## Years of schooling

<u>Data description:</u> *Number of years of schooling that a child of school entrance age can expect to receive if prevailing patterns of age-specific enrollment rates persist throughout the child's life.*

[Link to data.](http://hdr.undp.org/en/indicators/69706#) 

We focus on the 1990-2019 time-frame.

```{r}
un_years_of_schooling <- read.csv("data/un_years_of_schooling.csv", skip = 6, check.names = FALSE)
relevant_years <- as.character(1990:2019)
un_years_of_schooling <- un_years_of_schooling %>%
  select("Country", "HDI Rank", relevant_years) %>%
  mutate_at(relevant_years, as.numeric) %>%
  mutate_at("HDI Rank", as.numeric)
myun_years_of_schooling <- un_years_of_schooling
plot_missing_parameters(data = myun_years_of_schooling, use_counts = FALSE, max_100 = FALSE, 
                        ticks_angle = 45, ticks_size = 7.5, complete_cases_size = 3, complete_cases_hjust = 0.05)
```

<u>Observations:</u>

- As for previous variables, sparsity increases when we look at more ancient years, but never exceeds 12%. 
- Complete cases account for almost 90% of the data. For all of these countries, the data gives a full picture of the evolution of the years of schooling across time.
- A few countries are not ranked in terms of HDI. These countries are displayed below and correspond to countries that either (1) do not share their data eg. Korea or (2) countries with very small population (empirically < 40k) for which it is difficult to conduct data collection eg. Nauru.

```{r}
no_hdi_rank <- un_years_of_schooling %>%
  filter(is.na(`HDI Rank` )) %>%
  select(Country)  %>%
  select("Country") %>%
  rename("Countries with no HDI rank" = "Country")

knitr::kable(head(no_hdi_rank), "html")
```